<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Spectra Data Processor</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: Arial, sans-serif;
                line-height: 1.6;
                background: #f5f5f5;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                border-radius: 10px;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                overflow: hidden;
            }

            header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 30px;
                text-align: center;
            }

            h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
            }

            .main-content {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 30px;
                padding: 30px;
            }

            @media (max-width: 900px) {
                .main-content {
                    grid-template-columns: 1fr;
                }
            }

            .form-section {
                margin-bottom: 25px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #667eea;
            }

            .form-section h2 {
                color: #333;
                margin-bottom: 15px;
                padding-bottom: 10px;
                border-bottom: 2px solid #ddd;
            }

            .form-group {
                margin-bottom: 15px;
            }

            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: bold;
                color: #555;
            }

            .form-group input,
            .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 14px;
            }

            .form-group input:focus,
            .form-group select:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
            }

            .file-input-group {
                display: flex;
                gap: 10px;
                align-items: center;
            }

            .file-input-group input[type="file"] {
                flex: 1;
            }

            .file-count {
                font-size: 12px;
                color: #666;
                background: #e9ecef;
                padding: 5px 10px;
                border-radius: 4px;
                min-width: 80px;
                text-align: center;
            }

            .output-section {
                padding: 20px;
                background: #f8f9fa;
                border-radius: 8px;
                border-left: 4px solid #28a745;
            }

            .output-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 15px;
                align-items: center;
            }

            .output-path {
                flex: 1;
                padding: 10px;
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: monospace;
                min-height: 40px;
                display: flex;
                align-items: center;
            }

            .output-files {
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 15px;
                max-height: 300px;
                overflow-y: auto;
            }

            .output-file-item {
                padding: 10px;
                margin: 5px 0;
                background: #f8f9fa;
                border-radius: 4px;
                border-left: 3px solid #28a745;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .output-file-name {
                font-family: monospace;
                font-size: 14px;
            }

            .button-group {
                display: flex;
                gap: 10px;
                margin-top: 20px;
                flex-wrap: wrap;
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-primary:hover {
                background: #5a67d8;
                transform: translateY(-1px);
            }

            .btn-success {
                background: #28a745;
                color: white;
            }

            .btn-success:hover {
                background: #218838;
            }

            .btn-secondary {
                background: #6c757d;
                color: white;
            }

            .btn-secondary:hover {
                background: #5a6268;
            }

            .metadata-display {
                background: #f8f9fa;
                border-radius: 8px;
                padding: 20px;
                margin-top: 20px;
                border: 1px solid #ddd;
            }

            .metadata-display h3 {
                margin-bottom: 15px;
                color: #333;
            }

            #metadata-content {
                background: white;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 15px;
                font-family: monospace;
                font-size: 12px;
                max-height: 300px;
                overflow-y: auto;
                white-space: pre-wrap;
                word-wrap: break-word;
            }

            .progress-container {
                margin: 20px 0;
                padding: 15px;
                background: #e9ecef;
                border-radius: 8px;
                display: none;
            }

            .progress-container.active {
                display: block;
            }

            .progress-bar {
                height: 10px;
                background: #dee2e6;
                border-radius: 5px;
                overflow: hidden;
                margin: 10px 0;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #28a745, #20c997);
                width: 0%;
                transition: width 0.3s ease;
            }

            .progress-text {
                text-align: center;
                font-weight: bold;
                color: #333;
            }

            .status-message {
                text-align: center;
                color: #666;
                font-style: italic;
                margin-top: 10px;
            }

            .alert {
                padding: 15px;
                border-radius: 4px;
                margin: 10px 0;
                display: none;
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .alert-error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .alert-warning {
                background: #fff3cd;
                color: #856404;
                border: 1px solid #ffeaa7;
            }

            .section-title {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 15px;
            }

            .section-title button {
                padding: 8px 16px;
                font-size: 14px;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <header>
                <h1>Spectra Data Processor</h1>
                <p>Merge .asc files with standardized headers</p>
            </header>

            <div class="main-content">
                <!-- Left Column: Input Form -->
                <div>
                    <!-- Primary Inputs -->
                    <div class="form-section">
                        <div class="section-title">
                            <h2>Primary Inputs</h2>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="loadDefaults()"
                            >
                                Load Defaults
                            </button>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label for="product-name">Product Name *</label>
                                <input
                                    type="text"
                                    id="product-name"
                                    placeholder="e.g., Solaris_1000"
                                />
                            </div>
                            <div class="form-group">
                                <label for="additional-details"
                                    >Additional Details</label
                                >
                                <input
                                    type="text"
                                    id="additional-details"
                                    placeholder="e.g., AM coating"
                                />
                            </div>
                            <div class="form-group">
                                <label for="thickness">Thickness (mm) *</label>
                                <input
                                    type="number"
                                    id="thickness"
                                    step="0.01"
                                    value="11.0"
                                />
                            </div>
                            <div class="form-group">
                                <label for="emissivity-back"
                                    >Emissivity Back *</label
                                >
                                <input
                                    type="number"
                                    id="emissivity-back"
                                    step="0.000001"
                                    value="0.001234"
                                />
                            </div>
                            <div class="form-group">
                                <label for="appearance">Appearance *</label>
                                <input
                                    type="text"
                                    id="appearance"
                                    placeholder="e.g., Clear"
                                />
                            </div>
                            <div class="form-group">
                                <label for="nfrc-id">NFRC ID *</label>
                                <input
                                    type="number"
                                    id="nfrc-id"
                                    value="1000"
                                />
                            </div>
                            <div class="form-group">
                                <label for="substrate-filename"
                                    >Substrate Filename *</label
                                >
                                <input
                                    type="text"
                                    id="substrate-filename"
                                    placeholder="e.g., substrate.txt"
                                />
                            </div>
                        </div>
                    </div>

                    <!-- Secondary Inputs -->
                    <div class="form-section">
                        <h2>Secondary Inputs</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="wavelength">Wavelength Units</label>
                                <input
                                    type="text"
                                    id="wavelength"
                                    value="SI Microns"
                                />
                            </div>
                            <div class="form-group">
                                <label for="conductivity">Conductivity</label>
                                <input
                                    type="number"
                                    id="conductivity"
                                    step="0.000001"
                                    value="0.0"
                                />
                            </div>
                            <div class="form-group">
                                <label for="ir-transmittance"
                                    >IR Transmittance</label
                                >
                                <input
                                    type="number"
                                    id="ir-transmittance"
                                    step="0.000001"
                                    value="0.0123"
                                />
                            </div>
                            <div class="form-group">
                                <label for="emissivity-front"
                                    >Emissivity Front</label
                                >
                                <input
                                    type="number"
                                    id="emissivity-front"
                                    step="0.000001"
                                    value="0.00123"
                                />
                            </div>
                            <div class="form-group">
                                <label for="manufacturer">Manufacturer</label>
                                <input
                                    type="text"
                                    id="manufacturer"
                                    value="AIS"
                                />
                            </div>
                            <div class="form-group">
                                <label for="type">Type</label>
                                <input type="text" id="type" value="type" />
                            </div>
                            <div class="form-group">
                                <label for="material">Material</label>
                                <input type="text" id="material" value="N/A" />
                            </div>
                            <div class="form-group">
                                <label for="coated-side">Coated Side</label>
                                <select id="coated-side">
                                    <option value="front">Front</option>
                                    <option value="back">Back</option>
                                    <option value="both">Both</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- File Inputs -->
                    <div class="form-section">
                        <h2>Input Files</h2>

                        <div class="form-group">
                            <label>Directory 1 (.asc files)</label>
                            <div class="file-input-group">
                                <input
                                    type="file"
                                    id="dir1-files"
                                    multiple
                                    accept=".asc"
                                    onchange="updateFileCount('dir1')"
                                />
                                <div id="dir1-count" class="file-count">
                                    0 files
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Directory 2 (.asc files)</label>
                            <div class="file-input-group">
                                <input
                                    type="file"
                                    id="dir2-files"
                                    multiple
                                    accept=".asc"
                                    onchange="updateFileCount('dir2')"
                                />
                                <div id="dir2-count" class="file-count">
                                    0 files
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Directory 3 (.asc files)</label>
                            <div class="file-input-group">
                                <input
                                    type="file"
                                    id="dir3-files"
                                    multiple
                                    accept=".asc"
                                    onchange="updateFileCount('dir3')"
                                />
                                <div id="dir3-count" class="file-count">
                                    0 files
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Load Metadata JSON</label>
                            <div class="file-input-group">
                                <input
                                    type="file"
                                    id="metadata-file"
                                    accept=".json"
                                    onchange="loadMetadata()"
                                />
                                <div id="metadata-count" class="file-count">
                                    No file
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="button-group">
                        <button
                            type="button"
                            class="btn-primary"
                            onclick="processAllFiles()"
                        >
                            Process Files
                        </button>
                        <button
                            type="button"
                            class="btn-success"
                            onclick="saveMetadataConfig()"
                        >
                            Save Metadata
                        </button>
                        <button
                            type="button"
                            class="btn-secondary"
                            onclick="resetForm()"
                        >
                            Reset All
                        </button>
                    </div>
                </div>

                <!-- Right Column: Output Section -->
                <div>
                    <!-- Output Directory Selection -->
                    <div class="output-section">
                        <h2>Output Configuration</h2>

                        <div class="output-controls">
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="chooseOutputDirectory()"
                            >
                                Choose Output Folder
                            </button>
                            <div id="output-path-display" class="output-path">
                                No output folder selected
                            </div>
                        </div>

                        <div id="output-files" class="output-files">
                            <p
                                style="
                                    color: #666;
                                    text-align: center;
                                    padding: 20px;
                                "
                            >
                                Processed files will appear here
                            </p>
                        </div>

                        <div class="button-group">
                            <button
                                type="button"
                                class="btn-success"
                                onclick="downloadAllFiles()"
                                id="download-all-btn"
                                disabled
                            >
                                Download All Files
                            </button>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="clearOutput()"
                            >
                                Clear Output
                            </button>
                        </div>
                    </div>

                    <!-- Progress Display -->
                    <div id="progress-container" class="progress-container">
                        <h3>Processing Progress</h3>
                        <div class="progress-bar">
                            <div id="progress-fill" class="progress-fill"></div>
                        </div>
                        <div id="progress-text" class="progress-text">0%</div>
                        <div id="status-message" class="status-message">
                            Ready to process
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div id="alert-container"></div>

                    <!-- Metadata Display -->
                    <div class="metadata-display">
                        <div class="section-title">
                            <h3>Current Metadata</h3>
                            <button
                                type="button"
                                class="btn-secondary"
                                onclick="refreshMetadata()"
                            >
                                Refresh
                            </button>
                        </div>
                        <pre id="metadata-content">
Click "Refresh" to see metadata</pre
                        >
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Global state
            const state = {
                metadata: getDefaultMetadata(),
                files: {
                    dir1: [],
                    dir2: [],
                    dir3: [],
                },
                outputFiles: [],
                outputDirectory: null,
            };

            // Initialize
            document.addEventListener("DOMContentLoaded", function () {
                updateMetadataDisplay();
                setupFormListeners();
            });

            function getDefaultMetadata() {
                return {
                    Product_Name: "",
                    Additional_Details: "",
                    Thickness: 11.0,
                    Emissivity_back: 0.001234,
                    Appearance: "Clear",
                    NFRC_id: 1000,
                    Substrate_filename: "substrate.txt",
                    Wavelength: "SI Microns",
                    Conductivity: 0.0,
                    IR_Transmittance: 0.0123,
                    Emissivity_front: 0.00123,
                    Manufacturer: "AIS",
                    Type: "type",
                    Material: "N/A",
                    Coated_Side: "front",
                };
            }

            function setupFormListeners() {
                // Primary inputs
                document
                    .getElementById("product-name")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("additional-details")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("thickness")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("emissivity-back")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("appearance")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("nfrc-id")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("substrate-filename")
                    .addEventListener("input", updateMetadata);

                // Secondary inputs
                document
                    .getElementById("wavelength")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("conductivity")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("ir-transmittance")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("emissivity-front")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("manufacturer")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("type")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("material")
                    .addEventListener("input", updateMetadata);
                document
                    .getElementById("coated-side")
                    .addEventListener("change", updateMetadata);
            }

            function updateMetadata() {
                state.metadata = {
                    Product_Name: document.getElementById("product-name").value,
                    Additional_Details:
                        document.getElementById("additional-details").value,
                    Thickness:
                        parseFloat(
                            document.getElementById("thickness").value,
                        ) || 0,
                    Emissivity_back:
                        parseFloat(
                            document.getElementById("emissivity-back").value,
                        ) || 0,
                    Appearance: document.getElementById("appearance").value,
                    NFRC_id:
                        parseInt(document.getElementById("nfrc-id").value) || 0,
                    Substrate_filename:
                        document.getElementById("substrate-filename").value,
                    Wavelength: document.getElementById("wavelength").value,
                    Conductivity:
                        parseFloat(
                            document.getElementById("conductivity").value,
                        ) || 0,
                    IR_Transmittance:
                        parseFloat(
                            document.getElementById("ir-transmittance").value,
                        ) || 0,
                    Emissivity_front:
                        parseFloat(
                            document.getElementById("emissivity-front").value,
                        ) || 0,
                    Manufacturer: document.getElementById("manufacturer").value,
                    Type: document.getElementById("type").value,
                    Material: document.getElementById("material").value,
                    Coated_Side: document.getElementById("coated-side").value,
                };

                updateMetadataDisplay();
            }

            function updateMetadataDisplay() {
                const display = document.getElementById("metadata-content");
                display.textContent = JSON.stringify(state.metadata, null, 2);
            }

            function updateFileCount(dir) {
                const input = document.getElementById(`${dir}-files`);
                const countElement = document.getElementById(`${dir}-count`);

                if (input.files.length > 0) {
                    const ascFiles = Array.from(input.files).filter((f) =>
                        f.name.toLowerCase().endsWith(".asc"),
                    );
                    state.files[dir] = ascFiles;
                    countElement.textContent = `${ascFiles.length} .asc files`;
                    countElement.style.color = "#28a745";
                } else {
                    state.files[dir] = [];
                    countElement.textContent = "0 files";
                    countElement.style.color = "#666";
                }
            }

            function chooseOutputDirectory() {
                // Note: Browsers don't allow directory selection directly in file inputs
                // We'll use a workaround with a hidden folder input
                const folderInput = document.createElement("input");
                folderInput.type = "file";
                folderInput.webkitdirectory = true;
                folderInput.multiple = true;
                folderInput.style.display = "none";

                folderInput.addEventListener("change", function (e) {
                    if (e.target.files.length > 0) {
                        // Get the path from the first file
                        const filePath = e.target.files[0].webkitRelativePath;
                        const directoryPath = filePath.split("/")[0];

                        state.outputDirectory = directoryPath;
                        document.getElementById(
                            "output-path-display",
                        ).textContent = directoryPath;
                        document.getElementById(
                            "output-path-display",
                        ).style.color = "#28a745";

                        showAlert(
                            "Output directory selected: " + directoryPath,
                            "success",
                        );
                    }
                });

                document.body.appendChild(folderInput);
                folderInput.click();
                document.body.removeChild(folderInput);
            }

            async function processAllFiles() {
                try {
                    // Validate inputs
                    validateInputs();

                    // Show progress
                    showProgress(true);
                    updateProgress(0, "Starting processing...");

                    // Get file counts
                    const fileCounts = [
                        state.files.dir1.length,
                        state.files.dir2.length,
                        state.files.dir3.length,
                    ];

                    const minCount = Math.min(...fileCounts);

                    if (minCount === 0) {
                        throw new Error(
                            "Each directory must have at least one .asc file",
                        );
                    }

                    // Clear previous output
                    clearOutput();

                    // Process each file set
                    for (let i = 0; i < minCount; i++) {
                        updateProgress(
                            (i / minCount) * 100,
                            `Processing set ${i + 1} of ${minCount}...`,
                        );

                        try {
                            const fileSet = [
                                state.files.dir1[i],
                                state.files.dir2[i],
                                state.files.dir3[i],
                            ];

                            const result = await processFileSet(fileSet, i);
                            state.outputFiles.push(result);

                            // Add to output display
                            addOutputFile(result);
                        } catch (error) {
                            showAlert(
                                `Error processing set ${i + 1}: ${error.message}`,
                                "error",
                            );
                        }
                    }

                    updateProgress(100, "Processing complete!");
                    showAlert(
                        `Successfully processed ${state.outputFiles.length} files`,
                        "success",
                    );

                    // Enable download all button
                    document.getElementById("download-all-btn").disabled =
                        false;
                } catch (error) {
                    showAlert(error.message, "error");
                } finally {
                    setTimeout(() => showProgress(false), 2000);
                }
            }

            function validateInputs() {
                // Check required fields
                const required = [
                    { id: "product-name", name: "Product Name" },
                    { id: "thickness", name: "Thickness" },
                    { id: "nfrc-id", name: "NFRC ID" },
                    { id: "substrate-filename", name: "Substrate Filename" },
                ];

                for (const field of required) {
                    const value = document
                        .getElementById(field.id)
                        .value.trim();
                    if (!value) {
                        throw new Error(`${field.name} is required`);
                    }
                }

                // Check files
                const dirs = ["dir1", "dir2", "dir3"];
                for (const dir of dirs) {
                    if (state.files[dir].length === 0) {
                        throw new Error(
                            `Please select files for Directory ${dir.slice(-1)}`,
                        );
                    }
                }

                // Check output directory
                if (!state.outputDirectory) {
                    throw new Error("Please select an output directory");
                }
            }

            async function processFileSet(fileSet, index) {
                // Read all files
                const fileContents = await Promise.all(
                    fileSet.map((file) => readFileAsText(file)),
                );

                // Parse ASC data
                const parsedData = fileContents.map((content) =>
                    parseASCFile(content),
                );

                // Generate filename
                const filename = generateOutputFilename(index);

                // Create merged content
                const content = createMergedFile(parsedData, filename);

                return {
                    filename: filename,
                    content: content,
                    timestamp: new Date().toISOString(),
                    sourceFiles: fileSet.map((f) => f.name),
                };
            }

            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) =>
                        reject(new Error("Failed to read file"));
                    reader.readAsText(file);
                });
            }

            function parseASCFile(content) {
                const lines = content.split("\n");
                let inDataSection = false;
                const data = [];

                for (const line of lines) {
                    const trimmedLine = line.trim();

                    if (trimmedLine.startsWith("#DATA")) {
                        inDataSection = true;
                        continue;
                    }

                    if (
                        inDataSection &&
                        trimmedLine &&
                        !trimmedLine.startsWith("#")
                    ) {
                        const parts = trimmedLine
                            .split(/\s+/)
                            .filter((p) => p.length > 0);

                        if (parts.length >= 2) {
                            const wavelength = parseFloat(parts[0]);
                            const measurement = parseFloat(parts[1]);

                            if (!isNaN(wavelength) && !isNaN(measurement)) {
                                data.push({ wavelength, measurement });
                            }
                        }
                    }
                }

                return data;
            }

            function generateOutputFilename(index) {
                const nfrcId = state.metadata.NFRC_id || "unknown";
                const productName = (
                    state.metadata.Product_Name || "product"
                ).split("_")[0];
                const thickness = state.metadata.Thickness || 0;
                const additional = state.metadata.Additional_Details || "";

                // Clean additional details
                const cleanAdditional = additional
                    .replace(/[^a-zA-Z0-9]/g, "_")
                    .replace(/_{2,}/g, "_")
                    .trim("_");

                let filename = `${nfrcId}_${productName}_${thickness}mm`;

                if (cleanAdditional) {
                    filename += `_${cleanAdditional}`;
                } else if (index > 0) {
                    filename += `_${index + 1}`;
                }

                return filename + ".txt";
            }

            function createMergedFile(parsedData, filename) {
                const header = createHeader(filename);
                const dataLines = mergeDataLines(parsedData);

                return header + "\n" + dataLines.join("\n");
            }

            function createHeader(filename) {
                const checksum = (
                    (state.metadata.Emissivity_front || 0) +
                    (state.metadata.Emissivity_back || 0)
                ).toFixed(6);

                const coatingName =
                    `${state.metadata.Product_Name || ""}_${state.metadata.Thickness || 0}mm_${state.metadata.Additional_Details || ""}`
                        .replace(/\s+/g, "_")
                        .trim("_");

                return `{ Units Wavelength Units } ${state.metadata.Wavelength || "SI Microns"}
{ Thickness } ${state.metadata.Thickness || 0}
{ Conductivity } ${state.metadata.Conductivity || 0.0}
{ IR Transmittance } TIR=${state.metadata.IR_Transmittance || 0.0123}
{ Emissivity front back } Emis= ${state.metadata.Emissivity_front || 0.00123} ${state.metadata.Emissivity_back || 0.001234}
{ Ef_Source: Text Files }
{ Eb_Source: Text Files }
{ IGDB_Checksum: ${checksum} }
{ Product Name: ${filename} }
{ Manufacturer: ${state.metadata.Manufacturer || "AIS"} }
{ NFRC ID: ${state.metadata.NFRC_id || 0} }
{ Type: ${state.metadata.Type || "type"} }
{ Material: ${state.metadata.Material || "N/A"} }
{ Coating Name: ${coatingName} }
{ Coated Side: ${state.metadata.Coated_Side || "front"} }
{ Substrate Filename: ${state.metadata.Substrate_filename || ""} }
{ Appearance: ${state.metadata.Appearance || ""} }
{ Acceptance: # }
{ Uses: Glass }
{ Availability: X }
{ Structure: }`;
            }

            function mergeDataLines(parsedData) {
                const referenceData = parsedData[0];
                const dataLines = [];

                for (let i = 0; i < referenceData.length; i++) {
                    const values = [];

                    // First column: wavelength/1000
                    values.push(
                        (referenceData[i].wavelength / 1000).toFixed(6),
                    );

                    // Next three columns: measurement/100
                    for (let j = 0; j < parsedData.length; j++) {
                        if (parsedData[j] && parsedData[j][i]) {
                            values.push(
                                (parsedData[j][i].measurement / 100).toFixed(6),
                            );
                        } else {
                            values.push("0.000000");
                        }
                    }

                    dataLines.push(values.join(" "));
                }

                return dataLines;
            }

            function addOutputFile(file) {
                const outputFiles = document.getElementById("output-files");

                // Remove placeholder if present
                const placeholder = outputFiles.querySelector("p");
                if (placeholder) {
                    placeholder.remove();
                }

                const fileItem = document.createElement("div");
                fileItem.className = "output-file-item";

                fileItem.innerHTML = `
                <div class="output-file-name">${file.filename}</div>
                <button type="button" class="btn-secondary" onclick="downloadSingleFile('${file.filename}')" style="padding: 5px 10px; font-size: 12px;">
                    Download
                </button>
            `;

                outputFiles.appendChild(fileItem);

                // Store the file content in the button for easy access
                const downloadBtn = fileItem.querySelector("button");
                downloadBtn.dataset.content = file.content;
            }

            function downloadSingleFile(filename) {
                const file = state.outputFiles.find(
                    (f) => f.filename === filename,
                );
                if (!file) return;

                downloadFile(file.filename, file.content);
            }

            function downloadAllFiles() {
                if (state.outputFiles.length === 0) {
                    showAlert("No files to download", "warning");
                    return;
                }

                // Create a zip file or download individually
                if (state.outputFiles.length === 1) {
                    downloadFile(
                        state.outputFiles[0].filename,
                        state.outputFiles[0].content,
                    );
                } else {
                    // For multiple files, we'll create a zip using JSZip library
                    // For simplicity, we'll download them individually
                    showAlert("Downloading files individually...", "info");

                    state.outputFiles.forEach((file, index) => {
                        setTimeout(() => {
                            downloadFile(file.filename, file.content);
                        }, index * 100); // Stagger downloads
                    });
                }
            }

            function downloadFile(filename, content) {
                const blob = new Blob([content], { type: "text/plain" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = filename;
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            async function loadMetadata() {
                const input = document.getElementById("metadata-file");
                const countElement = document.getElementById("metadata-count");

                if (!input.files.length) return;

                try {
                    const file = input.files[0];
                    const content = await readFileAsText(file);
                    const metadata = JSON.parse(content);

                    // Merge with current metadata
                    state.metadata = { ...state.metadata, ...metadata };

                    // Update form fields
                    updateFormFromMetadata();
                    updateMetadataDisplay();

                    countElement.textContent = file.name;
                    countElement.style.color = "#28a745";

                    showAlert("Metadata loaded successfully", "success");
                } catch (error) {
                    countElement.textContent = "Error loading";
                    countElement.style.color = "#dc3545";
                    showAlert(
                        "Error loading metadata: " + error.message,
                        "error",
                    );
                }
            }

            function updateFormFromMetadata() {
                document.getElementById("product-name").value =
                    state.metadata.Product_Name || "";
                document.getElementById("additional-details").value =
                    state.metadata.Additional_Details || "";
                document.getElementById("thickness").value =
                    state.metadata.Thickness || 0;
                document.getElementById("emissivity-back").value =
                    state.metadata.Emissivity_back || 0.001234;
                document.getElementById("appearance").value =
                    state.metadata.Appearance || "";
                document.getElementById("nfrc-id").value =
                    state.metadata.NFRC_id || 1000;
                document.getElementById("substrate-filename").value =
                    state.metadata.Substrate_filename || "";
                document.getElementById("wavelength").value =
                    state.metadata.Wavelength || "SI Microns";
                document.getElementById("conductivity").value =
                    state.metadata.Conductivity || 0;
                document.getElementById("ir-transmittance").value =
                    state.metadata.IR_Transmittance || 0.0123;
                document.getElementById("emissivity-front").value =
                    state.metadata.Emissivity_front || 0.00123;
                document.getElementById("manufacturer").value =
                    state.metadata.Manufacturer || "AIS";
                document.getElementById("type").value =
                    state.metadata.Type || "type";
                document.getElementById("material").value =
                    state.metadata.Material || "N/A";
                document.getElementById("coated-side").value =
                    state.metadata.Coated_Side || "front";
            }

            function saveMetadataConfig() {
                updateMetadata(); // Ensure latest data

                const metadata = {
                    ...state.metadata,
                    timestamp: new Date().toISOString(),
                    version: "1.0",
                };

                const content = JSON.stringify(metadata, null, 2);
                downloadFile("metadata_config.json", content);
            }

            function loadDefaults() {
                state.metadata = getDefaultMetadata();
                updateFormFromMetadata();
                updateMetadataDisplay();
                showAlert("Default metadata loaded", "success");
            }

            function refreshMetadata() {
                updateMetadata();
                showAlert("Metadata refreshed", "info");
            }

            function clearOutput() {
                state.outputFiles = [];
                document.getElementById("output-files").innerHTML =
                    '<p style="color: #666; text-align: center; padding: 20px;">Processed files will appear here</p>';
                document.getElementById("download-all-btn").disabled = true;
            }

            function resetForm() {
                if (
                    confirm(
                        "Are you sure you want to reset the form? All unsaved data will be lost.",
                    )
                ) {
                    // Reset form fields
                    document
                        .querySelectorAll("input, select")
                        .forEach((element) => {
                            if (element.type !== "button") {
                                element.value = "";
                            }
                        });

                    // Reset file inputs
                    [
                        "dir1-files",
                        "dir2-files",
                        "dir3-files",
                        "metadata-file",
                    ].forEach((id) => {
                        document.getElementById(id).value = "";
                    });

                    // Reset file counts
                    ["dir1", "dir2", "dir3"].forEach((dir) => {
                        document.getElementById(`${dir}-count`).textContent =
                            "0 files";
                        document.getElementById(`${dir}-count`).style.color =
                            "#666";
                    });

                    document.getElementById("metadata-count").textContent =
                        "No file";
                    document.getElementById("metadata-count").style.color =
                        "#666";

                    // Reset state
                    state.metadata = getDefaultMetadata();
                    state.files = { dir1: [], dir2: [], dir3: [] };
                    state.outputDirectory = null;

                    // Reset output
                    clearOutput();
                    document.getElementById("output-path-display").textContent =
                        "No output folder selected";
                    document.getElementById("output-path-display").style.color =
                        "";

                    // Update display
                    updateMetadataDisplay();
                    showAlert("Form reset successfully", "success");
                }
            }

            function showProgress(show) {
                const container = document.getElementById("progress-container");
                if (show) {
                    container.classList.add("active");
                } else {
                    container.classList.remove("active");
                }
            }

            function updateProgress(percent, message) {
                document.getElementById("progress-fill").style.width =
                    `${percent}%`;
                document.getElementById("progress-text").textContent =
                    `${Math.round(percent)}%`;
                document.getElementById("status-message").textContent = message;
            }

            function showAlert(message, type = "info") {
                const alertContainer =
                    document.getElementById("alert-container");

                const alert = document.createElement("div");
                alert.className = `alert alert-${type}`;
                alert.textContent = message;

                alertContainer.appendChild(alert);
                alert.style.display = "block";

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    alert.style.opacity = "0";
                    alert.style.transition = "opacity 0.5s";
                    setTimeout(() => alert.remove(), 500);
                }, 5000);
            }
        </script>
    </body>
</html>
